/*! posterior - v0.9.3 - 2015-04-01
* http://esha.github.io/posterior/
* Copyright (c) 2015 ESHA Research; Licensed MIT, GPL */
!function(D,store){"use strict";var Posterior=window.Posterior=function(a,b){return Posterior.api(a,b)},XHR=Posterior.xhr=function(a){return XHR.main(a)},htmlClass=D.documentElement.classList;XHR.ctor=XMLHttpRequest,XHR.main=function(a){var b,c;return a.cache&&(b=store(XHR.key(a)),b&&(c=Promise.resolve(b))),c||(b=new XHR.ctor,XHR.config(b,a),c=XHR.promise(b,a),a.retry&&(c=c["catch"](XHR.retry.bind(b)))),a.then&&(c=c.then(a.then)),a["catch"]&&(c=c["catch"](a["catch"])),c.xhr=b,c},XHR.config=function(a,b){a.open(XHR.method(b),XHR.url(b),"async"in b?b.async:!0,b.username,b.password),a.cfg=b;for(var c in b){var d=b[c];c in a&&(a[c]=d),"function"==typeof d&&a.addEventListener(c,b[c]=d.bind(a))}if(b.mimeType&&a.overrideMimeType(b.mimeType),b.requestedWith!==!1&&a.setRequestHeader("X-Requested-With",b.requestedWith||"XMLHttpRequest"),b.json!==!1){try{a.responseType="json"}catch(e){}a.setRequestHeader("Accept","application/json"),a.setRequestHeader("Content-Type","application/json")}if(b.headers)for(var f in b.headers)a.setRequestHeader(f,b.headers[f])},XHR.method=function(a){return XHR.methodMap[a.method]||a.method||"GET"},XHR.methodMap={PATCH:"POST"},XHR.url=function(a){for(var b,c=a.url;b!==c;)b=c,c=c.replace(/([\/\?\&]|^)[^\/\.\?\&]+[\/\?\&]?\.\.([\/\?\&]?)/,"$1");return c},XHR.promise=function(a,b){return new Promise(function(c,d){var e=function(b){d(a.error=b)},f={error:e,timeout:e,loadstart:XHR.start,loadend:XHR.end,load:XHR.load(a,b,c,e)};for(var g in f)a.addEventListener(g,f[g]);try{a.send(XHR.data(b))}catch(h){e(h)}})},XHR.load=function(a,b,c,d){return function(){try{var e=b[a.status]||a.status;if("function"==typeof e&&(e=e(a)||a.status),e>=200&&300>e){b.json!==!1&&"object"!=typeof a.response&&XHR.forceJSONResponse(a),b.cache&&XHR.cache(a);var f=a.responseType?a.response:b.json!==!1?a.responseObject:a.responseText;if(b.responseData&&XHR.isData(f)){var g=b.responseData(f);f=void 0===g?f:g}c(XHR.isData(f)?f:a)}else d(e)}catch(h){d(h)}}},XHR.forceJSONResponse=function(a){try{delete a.response,Object.defineProperty(a,"response",{value:a.responseObject,enumerable:!0,configurable:!0})}catch(b){}},XHR.isData=function(a){return!(void 0===a||""===a)},XHR.data=function(a){var b=a.data;if(a.requestData&&XHR.isData(b)){var c=a.requestData(b);b=void 0===c?b:c}return void 0!==b&&"string"!=typeof b&&(b=JSON.stringify(b)),b||""},XHR.properties={responseObject:{get:function(){var a=null;try{this.responseText&&(a=JSON.parse(this.responseText))}catch(b){}return null===a&&"object"==typeof this.response&&(a=this.response),Object.defineProperty(this,"responseObject",{value:a}),a},enumerable:!0,configurable:!0},responseHeaders:{get:function(){for(var a,b={},c=this.getAllResponseHeaders().trim().split("\n"),d=0,e=c.length;e>d;d++)if(a=c[d]){var f=a.match(/^([\w\-]+):(.*)/);3===f.length&&(b[f[1]]=f[2].trim())}return Object.defineProperty(this,"responseHeaders",{value:b}),b},enumerable:!0,configurable:!0}},Object.defineProperties(XMLHttpRequest.prototype,XHR.properties),XHR.active=0,XHR.activeClass="xhr-active",XHR.start=function(){XHR.active++,htmlClass.add(XHR.activeClass)},XHR.end=function(){--XHR.active||htmlClass.remove(XHR.activeClass)},XHR.key=function(a){return XHR.url(a)+"|"+XHR.method(a)+"|"+XHR.data(a)},XHR.cache=function(a){var b=a.cfg;return store(XHR.key(b),XHR.safeCopy(a),b.cache),a},XHR.safeCopy=function(a,b){var c={};if(b=b||[],b.indexOf(a)<0){b.push(a);for(var d in a)try{var e=a[d],f=typeof e;"function"===f?e=void 0:"object"===f&&(e=XHR.safeCopy(e,b)),void 0!==e&&(c[d]=e)}catch(g){}return c}},XHR.retry=function(a){var b=this,c=b.cfg.retry;return(c.limit||3)>c.count?("number"==typeof c&&(c={wait:c}),new Promise(function(a){setTimeout(function(){c.count=(c.count||0)+1,c.wait=2*(c.wait||1e3),a(XHR(b.cfg))},c.wait||1e3)})):Promise.reject(a)};var API=Posterior.api=function(a,b){var c=a.parent||null;return c&&c.cfg&&(c=c.cfg),API.build(a,c,b)};API.build=function(a,b,c){var d=function(a){return API.main(d,a)},e={_fn:d,_parent:b,_private:{},name:c||"Posterior"};(a.debug||API.get(e,"debug"))&&(d=e._fn=API.debug(e.name,d));for(var f in a)API.set(e,f,a[f],e.name),API.getter(d,f);return d.cfg=e,d.config=API.config,d.extend=API.extend,API.get(e,"auto")&&setTimeout(d,0),d},API.extend=function(a,b){return API.build(a,this.cfg,b)},API.main=function(a,b){var c=API.getAll(a.cfg);c.data=b,API.process(c,b);var d=c.requires;return d?Promise.all(d.map(API.require.bind(c))).then(function(){return XHR(c)}):XHR(c)},API.require=function(req){var type=typeof req;if("string"===type)try{req=eval(req)}catch(e){return Promise.reject(new Error('Could not resolve "'+req+'".'))}if("function"===type){var ret=req();return Promise.resolve(void 0===ret?req:ret)}return req?Promise.resolve(req):Promise.reject(req)},API.config=function(a,b){return a?void 0===b?API.get(this.cfg,a):API.set(this.cfg,a,b):API.getAll(this.cfg)},API.process=function(a){a.configure&&a.configure(a);for(var b in a){var c=a[b];"string"==typeof c&&(c=a[b]=API.fill(c,a,a.data))}},API.fill=function(a,b,c){c=c||{};for(var d,e=a,f=/\$\{([^}]+)\}/g;d=f.exec(a);){d=d[1];var g=c[d];(null===g||void 0===g)&&(g=d in b?b[d]:""),e=e.replace(new RegExp("\\$\\{"+d+"}"),g),b.consumeData!==!1&&delete c[d]}return e},API.getAll=function(a,b){var c=a._parent?API.getAll(a._parent,!0):{};return API.copy(c,a),b||API.copy(c,a._private),c},API.copy=function(a,b){for(var c in b)"_"!==c.charAt(0)&&("!"===c.charAt(0)?a[c.substring(1)]=b[c]:a[c]=API.combine(a[c],b[c],a))},API.get=function(a,b,c){var d=a._private,e="!"+b;if(!c&&e in d)return d[e];if(e in a)return a[e];var f=c?a[b]:API.combine(a[b],d[b],a);return a._parent?API.combine(API.get(a._parent,b,!0),f,a):f},API.getter=function(a,b){try{Object.defineProperty(a,b,{get:function(){return API.get(a.cfg,b)},configurable:!0})}catch(c){}},API.set=function(a,b,c,d){var e=a._fn,f=d+("."===b.charAt(0)?"":".")+b;"function"==typeof c&&API.get(a,"debug")&&(c=API.debug(f,c)),"."===b.charAt(0)?e[b.substring(1)]=c:"@"===b.charAt(0)?e[b.substring(1)]=API.build(c,a,f):"_"===b.charAt(0)?a._private[b.substring(1)]=c:a[b]=c},API.debug=function(a,b){var c=window.console,d=Array.prototype.concat;return function(e){try{var f=[a+"("];f.push.apply(f,arguments),f.push(")");var g=b.apply(this,arguments);return void 0!==g&&g!==e&&c.debug.apply(c,[a,"->",g]),g}catch(h){var f=d.apply([a,h],arguments);throw c.error.apply(c,f),h}}},API.combine=function(a,b,c){var d=API.type(a),e=API.type(b);return e?d?e!==d?"function"===d?a.call(c,b):"function"===e?b.call(c,a):"array"===d?a.concat(b):"array"===e?[].concat.apply([a],b):a+b:"function"===e?API.combineFn(a,b):"object"===e?API.combineObject(a,b):"array"===e?a.concat.apply(a,b):"boolean"===e?a&&b:a+b:b:a},API.combineFn=function(a,b){return function(c){var d=a.call(this,c);return d=b.call(this,void 0===d?c:d),void 0===d?c:d}},API.combineObject=function(a,b){var c={};for(var d in a)c[d]=a[d];for(d in b)c[d]=b[d];return c},API.type=function(a){var b=typeof a;return"object"===b?Array.isArray(a)?"array":a?b:null:"undefined"===b?null:b},Posterior.version=""}(document,window.store||function(){});