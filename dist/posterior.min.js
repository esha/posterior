/*! posterior - v0.16.0 - 2016-05-24
* http://esha.github.io/posterior/
* Copyright (c) 2016 ESHA Research; Licensed MIT, GPL */
!function(D,store){"use strict";var Posterior=window.Posterior=function(a,b){return Posterior.api(a,b)},XHR=Posterior.xhr=function(a){return XHR.main(a)},htmlClass=D.documentElement.classList;XHR.ctor=XMLHttpRequest,XHR.main=function(a){var b,c;return a.cache&&(b=store(XHR.key(a)),b&&(c=Promise.resolve(b))),c||(b=new XHR.ctor,XHR.config(b,a),c=XHR.promise(b,a),a.cache&&c.then(function(){XHR.cache(b)})),a.then&&(c=c.then(a.then)),a["catch"]&&(c=c["catch"](function(c){return a["catch"].call(a,c,b)})),c.xhr=b,c},XHR.config=function(a,b){a.open(XHR.method(b),XHR.url(b),"async"in b?b.async:!0,b.username,b.password),a.cfg=b,b.xhr=a;for(var c in b){var d=b[c];c in a&&(a[c]=d),"function"==typeof d&&a.addEventListener(c,d.bind(a))}b.mimeType&&a.overrideMimeType(b.mimeType);var e=b.headers||(b.headers={});if(b.requestedWith!==!1&&(e["X-Requested-With"]=b.requestedWith||"XMLHttpRequest"),b.json!==!1){try{a.responseType="json"}catch(f){}e.Accept||(e.Accept="application/json"),e["Content-Type"]||(e["Content-Type"]="application/json")}for(var g in e)a.setRequestHeader(g,e[g])},XHR.method=function(a){return XHR.methodMap[a.method]||a.method||"GET"},XHR.methodMap={PATCH:"POST"},XHR.url=function(a){for(var b,c=a.url;b!==c;)b=c,c=c.replace(/([\/\?\&]|^)[^\/\.\?\&]+[\/\?\&]?\.\.([\/\?\&]?)/,"$1");return c},XHR.promise=function(a,b){return new Promise(function(c,d){var e=function(c){b.retry?XHR.retry(b,b.retry,f,e):d(a.error=c)},f={error:e,timeout:e,loadstart:XHR.start,loadend:XHR.end,load:XHR.load(b,c,e)};XHR[b.throttle?"throttle":"run"](a,b,f,e)})},XHR.retry=function(a,b,c,d){"object"!=typeof b&&(b=a.retry={}),b.wait="wait"in b?b.wait:1e3,b.limit="limit"in b?b.limit:3,b.count="count"in b?b.count:0,b.limit>b.count++&&setTimeout(function(){var b=new XHR.ctor;XHR.config(b,a),XHR.run(b,a,c,d)},b.wait*=2)},XHR.throttle=function(a,b,c,d){var e=XHR.throttles||(XHR.throttles={}),f=b.throttle,g=e[f.key];g||(g=e[f.key]={queue:0,lastRun:Date.now()-f.ms}),g.queue++;var h=g.lastRun+g.queue*f.ms-Date.now(),i=function(){XHR.run(a,b,c,d),g.queue--,g.lastRun=Date.now()};h>10?setTimeout(i,h):i()},XHR.run=function(a,b,c,d){for(var e in c)a.addEventListener(e,c[e]);try{a.send(XHR.data(b))}catch(f){d(f)}},XHR.load=function(a,b,c){return function(){try{var d=a.xhr,e=a[d.status]||d.status;if("function"==typeof e&&(e=e(d)||d.status),e>=200&&300>e){a.json!==!1&&"object"!=typeof d.response&&XHR.forceJSONResponse(d);var f=d.responseType?d.response:a.json!==!1?d.responseObject:d.responseText;if(a.responseData&&XHR.isData(f)){var g=a.responseData.call(d,f);f=void 0===g?f:g}b(XHR.isData(f)?f:d)}else{var h;a.failure&&(h=a.failure(e,d)),c(void 0!==h?h:e)}}catch(i){c(i)}}},XHR.forceJSONResponse=function(a){try{delete a.response,Object.defineProperty(a,"response",{value:a.responseObject,enumerable:!0,configurable:!0})}catch(b){}},XHR.isData=function(a){return!(void 0===a||""===a)},XHR.data=function(a){var b=a.data;if(a.requestData&&XHR.isData(b)){var c=a.requestData(b);b=void 0===c?b:c}return void 0!==b&&"string"!=typeof b&&(b=JSON.stringify(b)),b||""},XHR.properties={responseObject:{get:function(){var a=null;try{this.responseText&&(a=JSON.parse(this.responseText))}catch(b){}return null===a&&"object"==typeof this.response&&(a=this.response),Object.defineProperty(this,"responseObject",{value:a}),a},enumerable:!0,configurable:!0},responseHeaders:{get:function(){for(var a,b={},c=this.getAllResponseHeaders().trim().split("\n"),d=0,e=c.length;e>d;d++)if(a=c[d]){var f=a.match(/^([\w\-]+):(.*)/);3===f.length&&(b[f[1]]=f[2].trim())}return Object.defineProperty(this,"responseHeaders",{value:b}),b},enumerable:!0,configurable:!0}},Object.defineProperties(XMLHttpRequest.prototype,XHR.properties),XHR.active=0,XHR.activeClass="xhr-active",XHR.start=function(){XHR.active++,htmlClass.add(XHR.activeClass)},XHR.end=function(){--XHR.active||htmlClass.remove(XHR.activeClass)},XHR.key=function(a){return XHR.url(a)+"|"+XHR.method(a)+"|"+XHR.data(a)},XHR.cache=function(a){var b=a.cfg;return store(XHR.key(b),XHR.safeCopy(a),b.cache),a},XHR.safeCopy=function(a,b){var c={};if(b=b||[],b.indexOf(a)<0){b.push(a);for(var d in a)try{var e=a[d],f=typeof e;"function"===f?e=void 0:"object"===f&&(e=XHR.safeCopy(e,b)),void 0!==e&&(c[d]=e)}catch(g){}return c}};var API=Posterior.api=function(a,b){var c=a.parent||null;return c&&c.cfg&&(c=c.cfg),API.build(a,c,b)};API.build=function(a,b,c){var d=function(){return API.main(d,arguments)},e={_fn:d,_parent:b,_private:{},name:c||"Posterior"};(a.debug||API.get(e,"debug"))&&(d=e._fn=API.debug(e.name,d));for(var f in a)API.set(e,f,a[f],e.name),API.getter(d,f);return d.cfg=e,d.config=API.config,d.extend=API.extend,API.get(e,"auto")&&setTimeout(d,0),d},API.extend=function(a,b){return API.build(a,this.cfg,b)},API.main=function(a,b){if(a.cfg.savedResult)return Promise.resolve(a.cfg.savedResult);var c=API.getAll(a.cfg);c.data=b.length>1||"object"!=typeof b[0]?Array.prototype.slice.call(b):b[0],API.process(c);var d=API.promise(c,a);return c.saveResult&&d.then(function(b){a.cfg.savedResult=b}),d},API.promise=function(a,b){var c=a.requires;return c?Promise.all(c.map(API.require.bind(a))).then(function(){return API.follow(a,b)}):API.follow(a,b)},API.follow=function(cfg,fn){if(cfg.follows){var follows=cfg.follows,leader;return"object"==typeof follows&&(leader=follows.source,follows=follows.path),leader||(leader=fn.cfg._parent._fn),leader?leader().then(function following(resource){return cfg.url=follows&&eval("resource."+follows)||resource,XHR(cfg)}):Promise.reject("Cannot follow link relation without a parent function.")}return XHR(cfg)},API.require=function(req){try{return"string"==typeof req&&(req=eval("window."+req)),"function"==typeof req&&(req=req()||req),req?Promise.resolve(req):Promise.reject(req)}catch(e){return Promise.reject(e)}},API.config=function(a,b){return a?void 0===b?API.get(this.cfg,a):API.set(this.cfg,a,b):API.getAll(this.cfg)},API.process=function(a){a.configure&&a.configure(a);for(var b in a){var c=a[b];"string"==typeof c&&(c=a[b]=API.resolve(c,a.data,a,a.consumeData))}},API.resolve=function(string,data,cfg,consume){for(var key,str=string,re=/\$?\{([^}]+)\}/g,used=[];key=re.exec(string);){key=key[1];var val=null;if(key in data)val=data[key],consume!==!1&&used.indexOf(key)<0&&used.push(key);else{try{val=eval("data."+key),key=key.replace(/(\[|\.)/g,"\\$1")}catch(e){}void 0===val&&cfg&&key in cfg&&(val=cfg[key])}null!==val&&void 0!==val||(val=""),str=str.replace(new RegExp("\\$?\\{"+key+"}"),val)}if(consume!==!1&&used.length>0)if(Array.isArray(data)){used.sort();for(var i=used.length-1;i>=0;i--)data.splice(used[i],1)}else for(var j=0;j<used.length;j++)delete data[used[j]];return str},API.getAll=function(a,b){var c=a._parent?API.getAll(a._parent,!0):{};return API.copy(c,a),b||API.copy(c,a._private),c},API.copy=function(a,b){for(var c in b)"_"!==c.charAt(0)&&("!"===c.charAt(0)?a[c.substring(1)]=b[c]:a[c]=API.combine(a[c],b[c],a))},API.get=function(a,b,c){var d=a._private,e="!"+b;if(!c&&e in d)return d[e];if(e in a)return a[e];var f=c?a[b]:API.combine(a[b],d[b],a);return a._parent?API.combine(API.get(a._parent,b,!0),f,a):f},API.getter=function(a,b){try{Object.defineProperty(a,b,{get:function(){return API.get(a.cfg,b)},configurable:!0})}catch(c){}},API.set=function(a,b,c,d){var e=a._fn,f=d+("."===b.charAt(0)?"":".")+b;"function"==typeof c&&API.get(a,"debug")&&(c=API.debug(f,c)),"."===b.charAt(0)?e[b.substring(1)]=c:"@"===b.charAt(0)?e[b.substring(1)]=API.build(c,a,f):"_"===b.charAt(0)?a._private[b.substring(1)]=c:a[b]=c},API.debug=function(a,b){var c=window.console,d=Array.prototype.concat;return function(e){try{var f=[a+"("];f.push.apply(f,arguments),f.push(")");var g=b.apply(this,arguments);return void 0!==g&&g!==e&&c.debug.apply(c,[a,"->",g]),g}catch(h){var f=d.apply([a,h],arguments);throw c.error.apply(c,f),h}}},API.combine=function(a,b,c){var d=API.type(a),e=API.type(b);return e?d?e!==d?"function"===d?a.call(c,b):"function"===e?b.call(c,a):"array"===d?a.concat(b):"array"===e?[].concat.apply([a],b):a+b:"function"===e?API.combineFn(a,b):"object"===e?API.combineObject(a,b):"array"===e?a.concat.apply(a,b):"boolean"===e?a&&b:a+b:b:a},API.combineFn=function(a,b){return function(c){var d=a.call(this,c);return d=b.call(this,void 0===d?c:d),void 0===d?c:d}},API.combineObject=function(a,b){var c={};for(var d in a)c[d]=a[d];for(d in b)c[d]=b[d];return c},API.type=function(a){var b=typeof a;return"object"===b?Array.isArray(a)?"array":a?b:null:"undefined"===b?null:b},Posterior.version=""}(document,window.store||function(){});