/*! API(.js) - v0.1.0 - 2013-11-01
* https://github.com/nbubna/API
* Copyright (c) 2013 Nathan Bubna; Licensed MIT */
(function($,store){"use strict";var _={version:"<%= pkg.version %>",typeMap:{PATCH:"POST"},build:function(a,b,c){var d=function(){return _.promise.apply(d,arguments)},e=d.properties={self:d,selfName:c,parent:b};for(var f in a)if(a.hasOwnProperty(f)){var g=a[f],h=typeof g;if("object"===h){var i=_.build(g,e,f);d[f]=i,e[f]=i.properties}else"function"===h&&(g=g.bind(e)),"@"===f.charAt(0)&&(f=f.substring(1),d[f]=g),e[f]=g}var j=_.closest(e,"auto");return(j===!0||j>=0)&&setTimeout(d,j===!0?0:j),d},promise:function(){var a=this.properties,b=slice(arguments),c=[],d=_.closest(a,"cache")===!0&&a._promise;if("function"==typeof b[b.length-1]&&(c=b.pop().bind(a)),d)c&&d.done(c);else{var e=_.find(a,"requires").map(_.resolve);d=e.length?$.when.apply($,e).then(function(){return _.xhr(a,b,c)}):_.xhr(a,b,c),a._promise=d}return d},xhr:function(a,b,c){var d=_.config("data",a,b),e=_.url(a,d,b),f=_.closest(a,"type");f=_.typeMap[f]||f,_.empty(d)&&(d=void 0);var g=_.config("options",a,[f,e,d]);!e||"url"in g||(g.url=e),!f||"type"in g||(g.type=f),!d||"data"in g||(g.data=d),c&&(g.done=g.done?g.done.concat(c):c);var h=_.request(a,g);return _.responders(a,h,g)},request:function(a,b){var c=_.closest(a,"cache");return"number"==typeof c?(a._cached||(a._cacheKey=_.cacheKey(b),a._cached=store(a._cacheKey)),a._cached?$.when(a._cached,"success",null):$.ajax(b).done(function(b){store(a._cacheKey,a._cached=b,c),setTimeout(function(){delete a._cached},6e4*c)})):$.ajax(b)},cacheKey:function(a){return a.url+"|"+(a.type||"GET")+"|"+(a.data?JSON.stringify(a.data):"")},responders:function(a,b,c){return _.find(a,"then").forEach(function(d){b=b.then(function(b,e,f){var g=slice(arguments);return g.push(c),c.result=b,c.status=e,c.xhr=f,d.apply(a,g)})}),_.callback("done",a,b,c),_.callback("fail",a,b,c),_.callback("always",a,b,c),b},callback:function(a,b,c,d){var e=_.find(b,a);d[a]&&(e=e.concat(d[a])),e.length&&(b.prioritize&&e.reverse(),c[a](function(){var c=slice(arguments);1===c.length&&c.push(d.status,"done"===a?d.xhr:d.result),c.push(d);for(var f=0,g=e.length;g>f&&e[f].apply(b,c)!==!1;f++);}))},closest:function(a,b){var c="="+b;if(c in a)return a[c];var d="_"+b;if(d in a)return a[d];do if(b in a)return a[b];while(a=a.parent)},find:function(a,b){var c=[],d="_"+b,e="="+b;if(e in a)return _.prepend(a[e],c),c;d in a&&_.prepend(a[d],c);do b in a&&_.prepend(a[b],c);while(a=a.parent);return c},prepend:function(a,b){Array.isArray(a)?b.unshift.apply(b,a):b.unshift(a)},config:function(a,b,c){for(var d=_.find(b,a),e={},f=0,g=d.length;g>f;f++){var h=d[f];"function"==typeof h&&(h=h.apply(b,c));for(var i in h)e[i]=h[i]}return e},url:function(a,b,c){for(var d=_.find(a,"url"),e="",f=d.length-1;f>=0;f--){var g=d[f];if("function"==typeof g){e=g.apply(a,b);break}e=g+e}for(;e.indexOf("..")>=0;)e=e.replace(/[\/\?\&][^\/\.\?\&]+[\/\?\&]?\.\.([\/\?\&]?)/,"$1");return _.fill(e,b,c)},fill:function(a,b,c){b=b||{};for(var d,e=a,f=/\{(\w+)\}/g;d=f.exec(a);){d=d[1];var g=b[d];(null===g||void 0===g)&&(g=d in c?c[d]:""),e=e.replace(new RegExp("\\{"+d+"}"),g),delete b[d]}return e},headers:function(a){for(var b,c={},d=a.getAllResponseHeaders().trim().split("\n"),e=0,f=d.length;f>e;e++)if(b=d[e]){var g=b.match(/^([\w\-]+):(.*)/);3===g.length&&(c[g[1]]=g[2].trim())}return a.responseHeaders=c},empty:function(a){for(var b in a)return!b;return!0},refRE:/^([\w\$]+)?((\.[\w\$]+)|\[(\d+|'(\\'|[^'])+'|"(\\"|[^"])+")\])*$/,resolve:function(ref){return _.refRE.test(ref)&&(ref=eval("window"+("["!==ref.charAt(0)?"."+ref:ref))||ref),"function"==typeof ref&&(ref=ref()),ref}},slice=Function.prototype.call.bind(Array.prototype.slice),API=_.build;API._=_,_.toJSON=$.ajaxSettings.converters["text json"],$.ajaxSettings.converters["text json"]=function(a){return a?_.toJSON.apply(this,arguments):a},"function"==typeof define&&define.amd?define(function(){return API}):"undefined"!=typeof module&&module.exports?module.exports=API:(window.API=API,$.ajax.API=API)}).call(window,window.$,window.store||function(){});