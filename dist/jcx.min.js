/*! jcx - v0.1.2 - 2014-09-08
* http://esha.github.io/jcx/
* Copyright (c) 2014 ESHA Research; Licensed MIT, GPL */
!function(store){"use strict";var JCX=window.JCX=function(a){return JCX.api(a)},XHR=JCX.xhr=function(){return XHR.main.apply(this,arguments)},global=XHR.global={};XHR.main=function(a){var b,c;return a.cache&&(b=store(XHR.key(a)),b&&(c=Promise.resolve(b))),c||(b=XHR.create(a),c=XHR.promise(b,a),a.cache&&(c=c.then(XHR.cache))),c=c.then(a.then,a.catch).then(a.always,a.always).then(global.then,global.catch).then(global.always,global.always),b.cfg=a,c.xhr=b,c},XHR.methodMap={PATCH:"POST"},XHR.create=function(a){var b=XHR.methodMap[a.method]||a.method,c=new XMLHttpRequest;if(c.open(b,a.url,a.async,a.username,a.password),a.xhrFields)for(var d in a.xhrFields)c[d]=a.xhrFields[d];if(a.mimeType&&c.overrideMimeType(a.mimeType),a.headers)for(var e in a.headers)c.setRequestHeader(e,a.headers[e]);return c},XHR.promise=function(a,b){return new Promise(function(c,d){a.onload=function(){try{XHR.parse(a),XHR.headers(a);var b=a.status||200;(b>=200&&400>b?c:d)(a)}catch(e){a.error=e,d(a)}},a.onerror=function(){d(a)},XHR.active++;try{a.send("string"!=typeof b.data?JSON.stringify(b.data):null)}catch(e){a.error=e,d(a)}}).then(XHR.end,XHR.end).catch(b.retry?XHR.retry:null)},XHR.parse=function(a){try{a.value=JSON.parse(a.responseText)}catch(b){}},XHR.headers=function(a){for(var b,c={},d=a.getAllResponseHeaders().trim().split("\n"),e=0,f=d.length;f>e;e++)if(b=d[e]){var g=b.match(/^([\w\-]+):(.*)/);3===g.length&&(c[g[1]]=g[2].trim())}return a.responseHeaders=c},XHR.active=0,XHR.end=function(a){XHR.active--;var b=a.cfg[a.status]||global[a.status];return b&&b(a)||a},XHR.key=function(a){return a.url+"|"+(a.method||"GET")+"|"+(a.data?JSON.stringify(a.data):"")},XHR.cache=function(a){var b=a.cfg;store(XHR.key(b),XHR.safeCopy(a),b.cache)},XHR.safeCopy=function(a){var b={};for(var c in a){var d=a[c],e=typeof d;d&&"function"!==e&&(b[c]="object"===e?XHR.safeCopy(d):d)}return b},XHR.retry=function(a){var b=a.cfg.retry||global.retry;if(b){var c=a.cfg;return new Promise(function(a){setTimeout(function(){c.retry=2*b,a(XHR(c))},b)})}return a};var API=JCX.api=function(){return API.build.apply(this,arguments)};API.build=function(a,b){var c=function(a){return API.main(c,a)};c.cfg={_fn:c,_parent:b,_private:{}},c.config=API.config;for(var d in a)API.set(c.cfg,d,a[d]);return API.get(c.cfg,"auto")&&setTimeout(c,0),c},API.main=function(a,b){var c=API.getAll(a.cfg);API.process(c,b);var d=c.requires;return d?Promise.all(d.map(API.require.bind(c))).then(function(){return XHR(c)}):XHR(c)},API.require=function(req){var type=typeof req;if("string"===type)try{req=eval(req)}catch(e){return Promise.reject(new Error('Could not resolve "'+req+'".'))}if("function"===type){var ret=req();return Promise.resolve(void 0===ret?req:ret)}return req?Promise.resolve(req):Promise.reject(req)},API.config=function(a,b){return a?void 0===b?API.get(this.cfg,a):API.set(this.cfg,a,b):API.getAll(this.cfg)},API.process=function(a,b){for(var c in a){var d=a[c];if("string"==typeof d&&(d=a[c]=API.fill(d,a,b)),"url"===c){for(;d.indexOf("..")>=0;)d=d.replace(/[\/\?\&][^\/\.\?\&]+[\/\?\&]?\.\.([\/\?\&]?)/,"$1");a.url=d}}a.data=a.serialize?a.serialize(b):b},API.fill=function(a,b,c){c=c||{};for(var d,e=a,f=/\{(\w+)\}/g;d=f.exec(a);){d=d[1];var g=c[d];(null===g||void 0===g)&&(g=d in b?b[d]:""),e=e.replace(new RegExp("\\{"+d+"}"),g),delete c[d]}return e},API.getAll=function(a,b){var c=a._parent?API.getAll(a._parent,!0):{};return API.copy(c,a),b||API.copy(c,a._private),c},API.copy=function(a,b){for(var c in b)"_"!==c.charAt(0)&&("!"===c.charAt(0)?a[c.substring(1)]=b[c]:a[c]=API.combine(a[c],b[c]))},API.get=function(a,b,c){var d=a._private,e="!"+b;if(!c&&e in d)return d[e];if(e in a)return a[e];var f=c?a[b]:API.combine(a[b],d[b]);return a._parent?API.combine(API.get(a._parent,b,!0),f):f},API.set=function(a,b,c){var d=a._fn;"function"==typeof c&&(c=c.bind(a)),"."===b.charAt(0)?d[b.substring(1)]=c:"@"===b.charAt(0)?d[b.substring(1)]=API.build(c,a):"_"===b.charAt(0)?a._private[b.substring(1)]=c:a[b]=c},API.combine=function(a,b){var c=API.type(a),d=API.type(b);return d?c?d!==c?"function"===c?a(b):"function"===d?b(a):"array"===c?a.concat(b):"array"===d?[].concat.apply([a],b):a+b:"function"===d?API.combineFn(a,b):"object"===d?API.combineObject(a,b):"array"===d?a.concat.apply(a,b):"boolean"===d?a&&b:a+b:b:a},API.combineFn=function(a,b){return function(c){return b(a(c)||c)||c}},API.combineObject=function(a,b){var c={};for(var d in a)c[d]=a[d];for(d in b)c[d]=b[d];return c},API.type=function(a){var b=typeof a;return"object"===b?Array.isArray(a)?"array":a?b:null:"undefined"===b?null:b},JCX.version=""}(document,window.store||function(){});