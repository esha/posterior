/*! jcx - v0.5.1 - 2014-09-19
* http://esha.github.io/jcx/
* Copyright (c) 2014 ESHA Research; Licensed MIT, GPL */
!function(D,store){"use strict";var JCX=window.JCX=function(a,b){return JCX.api(a,b)},XHR=JCX.xhr=function(a){return XHR.main(a)},htmlClass=D.documentElement.classList;XHR.ctor=XMLHttpRequest,XHR.main=function(a){var b,c;a.cache&&(b=store(XHR.key(a)),b&&(c=Promise.resolve(b))),c||(b=new XHR.ctor,XHR.config(b,a),c=XHR.promise(b,a),a.cache&&(c=c.then(XHR.cache)));var d=XHR.chain(a.always);return c=c.then(d,d).then(XHR.chain(a.then),XHR.chain(a.catch)),c.xhr=b,c},XHR.config=function(a,b){a.open(XHR.method(b),XHR.url(b),"async"in b?b.async:!0,b.username,b.password),a.cfg=b;for(var c in b)c in a&&(a[c]=b[c]);if(b.mimeType&&a.overrideMimeType(b.mimeType),b.requestedWith!==!1&&a.setRequestHeader("X-Requested-With",b.requestedWith||"XMLHttpRequest"),b.json&&(a.responseType="json",a.setRequestHeader("Accept","application/json"),a.setRequestHeader("Content-Type","application/json")),b.headers)for(var d in b.headers)a.setRequestHeader(d,b.headers[d])},XHR.method=function(a){return XHR.methodMap[a.method]||a.method||"GET"},XHR.methodMap={PATCH:"POST"},XHR.url=function(a){for(var b,c=a.url;b!==c;)b=c,c=c.replace(/([\/\?\&]|^)[^\/\.\?\&]+[\/\?\&]?\.\.([\/\?\&]?)/,"$1");return c},XHR.promise=function(a,b){var c=new Promise(function(c,d){var e=function(b){a.error=b,d(a)};a.onerror=a.ontimeout=e,a.onloadstart=XHR.start,a.onload=function(){try{var d=b[a.status]||a.status;"function"==typeof d&&(d=d(a)||a.status),d>=200&&300>d?(b.json&&"object"!=typeof a.response&&XHR.forceJSONResponse(a),c(a)):e(d)}catch(f){e(f)}},a.onloadend=XHR.end;try{a.send(XHR.data(b))}catch(f){e(f)}});return b.retry?c.catch(XHR.chain(XHR.retry)):c},XHR.forceJSONResponse=function(a){try{delete a.response,Object.defineProperty(a,"response",{value:a.responseObject,configurable:!0})}catch(b){}},XHR.data=function(a){var b=a.data;return a.serialize&&(b=a.serialize(b)),void 0!==b&&"string"!=typeof b&&(b=JSON.stringify(b)),b||""},XHR.properties={responseObject:{get:function(){var a=null;try{this.responseText&&(a=JSON.parse(this.responseText))}catch(b){}return Object.defineProperty(this,"responseObject",{value:a}),a},enumerable:!0,configurable:!0},responseHeaders:{get:function(){for(var a,b={},c=this.getAllResponseHeaders().trim().split("\n"),d=0,e=c.length;e>d;d++)if(a=c[d]){var f=a.match(/^([\w\-]+):(.*)/);3===f.length&&(b[f[1]]=f[2].trim())}return Object.defineProperty(this,"responseHeaders",{value:b}),b},enumerable:!0,configurable:!0}},Object.defineProperties(XMLHttpRequest.prototype,XHR.properties),XHR.active=0,XHR.activeClass="xhr-active",XHR.start=function(){XHR.active++,htmlClass.add(XHR.activeClass)},XHR.end=function(){--XHR.active||htmlClass.remove(XHR.activeClass)},XHR.key=function(a){return XHR.url(a)+"|"+XHR.method(a)+"|"+XHR.data(a)},XHR.cache=function(a){var b=a.cfg;return store(XHR.key(b),XHR.safeCopy(a),b.cache),a},XHR.safeCopy=function(a,b){var c={};if(b=b||[],b.indexOf(a)<0){b.push(a);for(var d in a){var e=a[d],f=typeof e;"function"===f?e=void 0:"object"===f&&(e=XHR.safeCopy(e,b)),void 0!==e&&(c[d]=e)}return c}},XHR.chain=function(a){return a?function(b){var c=a(b);return c!==b&&void 0!==c?c:b.error?Promise.reject(b):b}:void 0},XHR.retry=function(a){var b=a.cfg.retry;return b&&(b.limit||3)>b.count?("number"==typeof b&&(b={wait:b}),new Promise(function(c){setTimeout(function(){b.count=(b.count||0)+1,b.wait=2*(b.wait||1e3),c(XHR(a.cfg))},b.wait||1e3)})):a};var API=JCX.api=function(a,b){return API.build(a,null,b)};API.build=function(a,b,c){var d=function(a){return API.main(d,a)},e={_fn:d,_parent:b,_private:{}};(a.debug||API.get(e,"debug"))&&(d=e._fn=API.debug(c||"JCX",d));for(var f in a)API.set(e,f,a[f],c);return d.cfg=e,d.config=API.config,API.get(e,"auto")&&setTimeout(d,0),d},API.main=function(a,b){var c=API.getAll(a.cfg);c.data=b,API.process(c,b);var d=c.requires;return d?Promise.all(d.map(API.require.bind(c))).then(function(){return XHR(c)}):XHR(c)},API.require=function(req){var type=typeof req;if("string"===type)try{req=eval(req)}catch(e){return Promise.reject(new Error('Could not resolve "'+req+'".'))}if("function"===type){var ret=req();return Promise.resolve(void 0===ret?req:ret)}return req?Promise.resolve(req):Promise.reject(req)},API.config=function(a,b){return a?void 0===b?API.get(this.cfg,a):API.set(this.cfg,a,b):API.getAll(this.cfg)},API.process=function(a){a.preprocess&&a.preprocess(a);for(var b in a){var c=a[b];"string"==typeof c&&(c=a[b]=API.fill(c,a,a.data))}},API.fill=function(a,b,c){c=c||{};for(var d,e=a,f=/\$\{([^}]+)\}/g;d=f.exec(a);){d=d[1];var g=c[d];(null===g||void 0===g)&&(g=d in b?b[d]:""),e=e.replace(new RegExp("\\$\\{"+d+"}"),g),delete c[d]}return e},API.getAll=function(a,b){var c=a._parent?API.getAll(a._parent,!0):{};return API.copy(c,a),b||API.copy(c,a._private),c},API.copy=function(a,b){for(var c in b)"_"!==c.charAt(0)&&("!"===c.charAt(0)?a[c.substring(1)]=b[c]:a[c]=API.combine(a[c],b[c]))},API.get=function(a,b,c){var d=a._private,e="!"+b;if(!c&&e in d)return d[e];if(e in a)return a[e];var f=c?a[b]:API.combine(a[b],d[b]);return a._parent?API.combine(API.get(a._parent,b,!0),f):f},API.set=function(a,b,c,d){var e=a._fn;"function"==typeof c&&(c=c.bind(a),API.get(a,"debug")&&(c=API.debug(d+("."===b.charAt(0)?"":".")+b,c))),"."===b.charAt(0)?e[b.substring(1)]=c:"@"===b.charAt(0)?e[b.substring(1)]=API.build(c,a,b):"_"===b.charAt(0)?a._private[b.substring(1)]=c:a[b]=c},API.debug=function(a,b){var c=window.console,d=Array.prototype.concat;return function(e){try{var f=b.apply(this,arguments),g=d.apply([a],arguments);return void 0!==f&&f!==e&&g.push(f),c.debug.apply(c,g),f}catch(h){var g=d.apply([a,h],arguments);throw c.error.apply(c,g),h}}},API.combine=function(a,b){var c=API.type(a),d=API.type(b);return d?c?d!==c?"function"===c?a(b):"function"===d?b(a):"array"===c?a.concat(b):"array"===d?[].concat.apply([a],b):a+b:"function"===d?API.combineFn(a,b):"object"===d?API.combineObject(a,b):"array"===d?a.concat.apply(a,b):"boolean"===d?a&&b:a+b:b:a},API.combineFn=function(a,b){return function(c){return b(a(c)||c)||c}},API.combineObject=function(a,b){var c={};for(var d in a)c[d]=a[d];for(d in b)c[d]=b[d];return c},API.type=function(a){var b=typeof a;return"object"===b?Array.isArray(a)?"array":a?b:null:"undefined"===b?null:b},JCX.version=""}(document,window.store||function(){});