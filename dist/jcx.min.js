/*! jcx - v0.1.0 - 2014-09-02
* http://esha.github.io/jcx/
* Copyright (c) 2014 ESHA Research; Licensed MIT, GPL */
!function(store){"use strict";var JCX=window.JCX={},XHR=JCX.xhr=function(a){var b=new XMLHttpRequest,c=XHR.methodMap[a.method]||a.method;if(b.options=a,b.open(c,a.url,a.async,a.username,a.password),a.xhrFields)for(var d in a.xhrFields)b[d]=a.xhrFields[d];if(a.mimeType&&b.overrideMimeType(a.mimeType),a.headers)for(var e in a.headers)b.setRequestHeader(e,a.headers[e]);var f=new Promise(function(c,d){b.onload=function(){XHR.json(b),XHR.headers(b);var a=b.status||200;(a>=200&&400>a?c:d)(b)},b.onerror=function(){d(b)},XHR.active++,b.send(a.data||null)}).then(XHR.end,XHR.end).then(a.success,a.error).then(XHR.success,XHR.error);return f.xhr=b,f};XHR.methodMap={PATCH:"POST"},XHR.active=0,XHR.json=function(a){try{a.responseJson=JSON.parse(a.responseText)}catch(b){}},XHR.headers=function(a){for(var b,c={},d=a.getAllResponseHeaders().trim().split("\n"),e=0,f=d.length;f>e;e++)if(b=d[e]){var g=b.match(/^([\w\-]+):(.*)/);3===g.length&&(c[g[1]]=g[2].trim())}return a.responseHeaders=c},XHR.end=function(a){XHR.active--;var b=a.options[a.status]||XHR[a.status];return b&&b(a)||a};var _=JCX._={version:"0.1.0",build:function(a,b,c){var d=function(){return _.promise.apply(d,arguments)},e=d.properties={self:d,selfName:c,parent:b};for(var f in a)if(a.hasOwnProperty(f)){var g=a[f],h=typeof g;if("object"===h){var i=_.build(g,e,f);d[f]=i,e[f]=i.properties}else"function"===h&&(g=g.bind(e)),"@"===f.charAt(0)&&(f=f.substring(1),d[f]=g),e[f]=g}var j=_.closest(e,"auto");return(j===!0||j>=0)&&setTimeout(d,j===!0?0:j),d},promise:function(){var a=this.properties,b=slice(arguments),c=[],d=_.closest(a,"cache")===!0&&a._promise;if("function"==typeof b[b.length-1]&&(c=b.pop().bind(a)),d)c&&d.then(c);else{var e=_.find(a,"requires").map(_.resolve);d=e.length?Promise.all(e).then(function(){return _.xhr(a,b,c)}):_.xhr(a,b,c),a._promise=d}return d},xhr:function(a,b,c){var d=_.config("data",a,b),e=_.url(a,d,b),f=_.closest(a,"method");_.empty(d)&&(d=void 0);var g=_.config("options",a,[f,e,d]);!e||"url"in g||(g.url=e),!f||"method"in g||(g.method=f),!d||"data"in g||(g.data=d),c&&(g.then=g.then?g.then.concat(c):c);var h=_.request(a,g);return _.responders(a,h,g)},request:function(a,b){var c=_.closest(a,"cache");return"number"==typeof c?(a._cached||(a._cacheKey=_.cacheKey(b),a._cached=store(a._cacheKey)),a._cached?Promise.resolve({responseJson:a._cached}):XHR(b).then(function(b){store(a._cacheKey,a._cached=b,c),setTimeout(function(){delete a._cached},6e4*c)})):XHR(b)},cacheKey:function(a){return a.url+"|"+(a.method||"GET")+"|"+(a.data?JSON.stringify(a.data):"")},responders:function(a,b,c){return _.find(a,"then").forEach(function(d){b=b.then(function(b,e,f){var g=slice(arguments);return g.push(c),c.result=b,c.status=e,c.xhr=f,d.apply(a,g)})}),_.callback("then",a,b,c),_.callback("fail",a,b,c),_.callback("always",a,b,c),b},callback:function(a,b,c,d){var e=_.find(b,a);d[a]&&(e=e.concat(d[a])),e.length&&(b.prioritize&&e.reverse(),c[a](function(){var c=slice(arguments);1===c.length&&c.push(d.status,"then"===a?d.xhr:d.result),c.push(d);for(var f=0,g=e.length;g>f&&e[f].apply(b,c)!==!1;f++);}))},closest:function(a,b){var c="="+b;if(c in a)return a[c];var d="_"+b;if(d in a)return a[d];do if(b in a)return a[b];while(a=a.parent)},find:function(a,b){var c=[],d="_"+b,e="="+b;if(e in a)return _.prepend(a[e],c),c;d in a&&_.prepend(a[d],c);do b in a&&_.prepend(a[b],c);while(a=a.parent);return c},prepend:function(a,b){Array.isArray(a)?b.unshift.apply(b,a):b.unshift(a)},config:function(a,b,c){for(var d=_.find(b,a),e={},f=0,g=d.length;g>f;f++){var h=d[f];"function"==typeof h&&(h=h.apply(b,c));for(var i in h)e[i]=h[i]}return e},url:function(a,b,c){for(var d=_.find(a,"url"),e="",f=d.length-1;f>=0;f--){var g=d[f];if("function"==typeof g){e=g.apply(a,b);break}e=g+e}for(;e.indexOf("..")>=0;)e=e.replace(/[\/\?\&][^\/\.\?\&]+[\/\?\&]?\.\.([\/\?\&]?)/,"$1");return _.fill(e,b,c)},fill:function(a,b,c){b=b||{};for(var d,e=a,f=/\{(\w+)\}/g;d=f.exec(a);){d=d[1];var g=b[d];(null===g||void 0===g)&&(g=d in c?c[d]:""),e=e.replace(new RegExp("\\{"+d+"}"),g),delete b[d]}return e},empty:function(a){for(var b in a)return!b;return!0},refRE:/^([\w\$]+)?((\.[\w\$]+)|\[(\d+|'(\\'|[^'])+'|"(\\"|[^"])+")\])*$/,resolve:function(ref){return _.refRE.test(ref)&&(ref=eval("window"+("["!==ref.charAt(0)?"."+ref:ref))||ref),"function"==typeof ref&&(ref=ref()),ref}},slice=Function.prototype.call.bind(Array.prototype.slice),API=_.build;API._=_}(document,window.store||function(){});